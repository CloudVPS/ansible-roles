---

  - name: prep os for more open files
    lineinfile:
      line="{{ item }}"
      dest=/etc/security/limits.conf
    with_items:
      - "ubuntu soft nofile 65535"
      - "ubuntu hard nofile 65535"
    tags:
      - redis

  - name: prep os for more tcp backlog
    sysctl:
      name=net.core.somaxconn
      value=512
      state=present
    tags:
      - redis

#  - name: add redis ppa
#    apt_repository:
#      repo='ppa:chris-lea/redis-server'
#      state=present
#      update_cache=yes
#    tags:
#     - redis

  - name: install packages
    apt:
      pkg="{{ item }}"
      state=present
    with_items:
      - redis-server
      - redis-tools
    register: aptredis
    tags:
     - redis

  - name: set redis default configuration file
    copy:
     src="redis-default.conf"
     dest="/etc/default/redis-server"
    notify:
      - restart redis
    when: aptredis.changed
    tags:
      - redis

  - name: set redis initial configuration file
    template:
      src="redis.conf-1404.j2"
      dest="/etc/redis/redis.conf"
    when: ansible_distribution == 'Ubuntu' and ansible_distribution_version|int < '16.04' and aptredis.changed
    notify:
      - restart redis
    tags:
      - redis

  - name: set redis initial configuration file
    template:
      src="redis.conf.j2"
      dest="/etc/redis/redis.conf"
    when: ansible_distribution == 'Ubuntu' and ansible_distribution_version|int >= '16.04' and aptredis.changed
    notify:
      - restart redis
    tags:
      - redis

